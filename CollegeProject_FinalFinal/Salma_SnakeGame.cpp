#include "SnakeGame.h"
#include <conio.h>
#include<iostream>
#include <time.h>

SnakeGame::SnakeGame()
{
	pgrid = new Grid(20, 60, 20, 10, ' ');
	pconsole = new Console;

	DrawSnakeGrid();
	InitalizeSnake();
	Apple();
	pgrid->Draw();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

}

SnakeGame::~SnakeGame()
{
	delete pgrid;
	delete pconsole;
}

void SnakeGame::GameLoop()
{
	while (!gameOver)
	{
		MoveSnake();
		pconsole->Clear();
		pgrid->Draw();
		gameOver = IsGameOver();

		if (IsCollidedApple())
		{
			Apple();
			GrowSnake();
			pconsole->Clear();
			pgrid->Draw();
		}
	}

	std::cout << "Game Over!!" << std::endl;
}

void SnakeGame::DrawSnakeGrid()
{
	//draw borders
	for (unsigned int i = 0; i < pgrid->GetGridHeight(); i++)
	{
		for (unsigned int j = 0; j < pgrid->GetGridWidth(); j++)
		{
			if (i == 0 || i == pgrid->GetGridHeight() - 1) { pgrid->DrawAtPixel(i, j, '#'); }
			else if (j == 0 || j == pgrid->GetGridWidth() - 1) { pgrid->DrawAtPixel(i, j, '#'); }
			else pgrid->DrawAtPixel(i, j, ' ');
		}
	}
}

void SnakeGame::InitalizeSnake()
{
	snake.head.x = 10;
	snake.head.y = 10;
	snake.bodyParts.resize(1, Vector2{ 10,11 });

	snake.bodyParts.push_back(Vector2{ 10, 12 });
	snake.bodyParts.push_back(Vector2{ 10, 13 });
	snake.bodyParts.push_back(Vector2{ 10, 14 });
	snake.bodyParts.push_back(Vector2{ 10, 15 });
	snake.bodyParts.push_back(Vector2{ 10, 16 });


	pgrid->DrawAtPixel(snake.head.x, snake.head.y, '0');
	for (Vector2 coordinate : snake.bodyParts)
	{
		pgrid->DrawAtPixel(coordinate.x, coordinate.y, '*');
	}

}


void SnakeGame::MoveSnake()
{
	char key =  _getch();

	//erase old snake
	pgrid->DrawAtPixel(snake.head.x, snake.head.y, ' ');
	for (Vector2 pos : snake.bodyParts)
	{
		pgrid->DrawAtPixel(pos.x, pos.y, ' ');
	}

	Vector2 previousHeadPos = snake.head;
	switch (key)
	{
	case 'w':
		snake.head.x -= 1; //go up
		break;

	case 's':
		snake.head.x += 1; //go down
		break;

	case 'a':
		snake.head.y -= 1; //go right
		break;

	case 'd':
		snake.head.y += 1; //go left
		break;
	}

	Vector2 previousPos = previousHeadPos;
	Vector2 tempPreviousPos = previousHeadPos;

	for (int i = 0; i < snake.bodyParts.size(); i++)
	{
		//same idea as swapping variables values
		tempPreviousPos = snake.bodyParts[i];
		snake.bodyParts[i] = previousPos;
		previousPos = tempPreviousPos;
	}


	//draw new snake
	if (!IsCollidedBorder())
	{
		pgrid->DrawAtPixel(snake.head.x, snake.head.y, '0');
		for (Vector2 coordinate : snake.bodyParts)
		{
			pgrid->DrawAtPixel(coordinate.x, coordinate.y, '*');
		}
	}

}

bool SnakeGame::IsCollidedBorder()
{
	//only the head can be collided with borders
	if (snake.head.x >= pgrid->GetGridHeight() - 1 || snake.head.x <= 0 || 
		snake.head.y <= 0 ||  snake.head.y >= pgrid->GetGridWidth() - 1)
	{
		return true;
	}
	return false;
}
 
bool SnakeGame::IsCollidedItself()
{
	//if two parts has the same coordinates then they collided with each other

	for (int key = 0; key < snake.bodyParts.size(); key++)
	{
		for (int compareto = 0; compareto < snake.bodyParts.size(); compareto++)
		{
			if (key == compareto) continue; //don't compare to itself
			if (snake.bodyParts[key] == snake.bodyParts[compareto]) //two parts has same position , means collision
			{
				return true;
			}
		}
	}
	return false;
}

bool SnakeGame::IsGameOver()
{
	return IsCollidedBorder() || IsCollidedItself();
}


void SnakeGame::Apple()
{
	srand(time(NULL));

	applePos.x = 1 + (rand() % pgrid->GetGridHeight()-2);
	applePos. y= 1 + (rand() % pgrid->GetGridWidth()-2);
	//ToDo: check position of apple that it is not spawned at border or any of snake parts
	pgrid->DrawAtPixel(applePos.x, applePos.y, '$');

}

bool SnakeGame::IsCollidedApple()
{
	return snake.head == applePos;
}

void SnakeGame::GrowSnake()
{
	//check if new part will collide with border or snake, choose part that won't collide
	//check four directions
	int bodyPartssize = snake.bodyParts.size();
	Vector2 lastBodyPartPos = snake.bodyParts[bodyPartssize - 1];

	if ((lastBodyPartPos.x + 1 < pgrid->GetGridWidth() - 1)) //add to the left
	{
		snake.bodyParts.push_back(Vector2{lastBodyPartPos.x + 1, lastBodyPartPos.y});
	}
	else if ((lastBodyPartPos.x - 1 > 0)) //add to the right
	{
		snake.bodyParts.push_back(Vector2{ lastBodyPartPos.x - 1, lastBodyPartPos.y });
	}
	else if ((lastBodyPartPos.y + 1 < pgrid->GetGridHeight() - 1)) //add to up
	{
		snake.bodyParts.push_back(Vector2{ lastBodyPartPos.x, lastBodyPartPos.y + 1 });
	}
	else //add to down
	{
		snake.bodyParts.push_back(Vector2{ lastBodyPartPos.x, lastBodyPartPos.y - 1 });
	}
}
